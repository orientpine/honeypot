---
name: figure
description: 국책과제 연구계획서 출력 문서에서 <이미지명> 형식의 캡션을 추출하고, 각 캡션에 대해 PPT 스타일 인포그래픽 이미지 생성 프롬프트를 작성한 후, Gemini API(gemini-3-pro-image-preview)를 통해 실제 이미지를 생성하는 스킬. 사용자가 figure-generator를 사용해달라고 요청하거나 연구계획서의 이미지를 생성해달라고 요청할 때 이 스킬을 사용한다.
---

# Figure Generator

## ⚠️ CRITICAL: 검증문서 생성 필수 규칙

**절대 스킵 금지 (NEVER SKIP)**
- 프롬프트 생성 후 검증 보고서는 **반드시** 생성해야 함
- 어떤 상황에서도 실행 보고서 생성 단계를 생략하거나 스킵할 수 없음
- 사용자가 "스킵해도 된다"고 해도 보고서는 생성해야 함
- 보고서 없이 작업을 완료하면 **전체 작업이 무효화됨**

**검증문서 정보**
- 파일명: `figure_generation_report.md`
- 생성 시점: Phase 5 (이미지 생성 완료 후)
- 저장 위치: `{output_dir}/`

**위반 시 처리**
- 보고서 없이 작업이 완료된 경우: 즉시 작업 중단 후 보고서 먼저 생성

---

## Overview

국책과제 연구계획서(ISD) 출력 문서에서 이미지 캡션을 추출하고, 전문적인 PPT 스타일 인포그래픽 이미지를 자동 생성하는 스킬이다. Gemini API(gemini-3-pro-image-preview 모델)를 활용하여 정부 발표자료 수준의 고품질 이미지를 생성한다.

핵심 기능:
- 모든 출력 문서에서 `<이미지명>` 형식의 캡션 자동 추출
- 캡션 유형별 분류 및 프롬프트 템플릿 적용
- Gemini API + Python 스크립트를 통한 이미지 자동 생성
- 누락 확인 및 재생성
- 실행 보고서 생성

---

## 사용자 입력 스키마

스킬 실행 전 반드시 다음 정보를 수집해야 한다:

### 필수 입력

| 항목 | 설명 | 예시 |
|------|------|------|
| 출력 문서 디렉토리 경로 | Chapter 1~5 문서가 저장된 폴더 | `output/농업로봇_군집제어_2027/` |

### 선택 입력

| 항목 | 설명 | 기본값 | 예시 |
|------|------|--------|------|
| 이미지 출력 폴더 | 생성된 이미지 저장 위치 | `[출력 디렉토리]/figures/` | `output/프로젝트명/figures/` |
| 프롬프트 출력 폴더 | 프롬프트 파일 저장 위치 | `[출력 디렉토리]/prompts/` | `output/프로젝트명/prompts/` |
| 특정 Chapter 처리 | 특정 Chapter만 처리 | 전체 (chapter_1~5) | `chapter_3` |
| 이미지 해상도 | 생성 이미지 해상도 | `4K` | (고정) |
| 모델 | Gemini 모델 | `gemini-3-pro-image-preview` | (고정) |
| 색상 팔레트 오버라이드 | 사용자 지정 4색 팔레트 | 기본 파란색 계열 | 사용자 지정 |
| **auto_mode** | 자동 진행 모드 (확인 단계 건너뛰기) | `false` | `true` (orchestrator 호출 시) |
| **parallel_mode** | 서브에이전트 병렬 생성 모드 | `false` | `true` (다수 캡션 시) |
| **quality_gate** | 품질 검증 수준 | `normal` | `strict` (500줄+ 필수) |

---

## 일관성 컨텍스트 문서

서브에이전트 병렬 실행 시 문서 일관성을 위해 다음 컨텍스트 문서를 생성하고 모든 서브에이전트에 전달한다:

### consistency_context.md 구조

| 항목 | 내용 | 예시 |
|------|------|------|
| 프로젝트명 | 과제 이름 | 필드로봇_자율화_2027 |
| 4색 팔레트 | HEX 코드 + 용도 | #1E3A5F, #4A90A4, #2E7D5A, #F5F7FA |
| 폰트 규격 | 크기/굵기 표 | 대제목 24pt Bold, 섹션 제목 18pt Bold 등 |
| 박스 스타일 | radius, shadow | 8px, 10% opacity |
| 핵심 용어 | 과제별 용어 목록 | Physical AI, 레트로핏, VLM, Cross-Embodiment 등 |
| 기관명 | 참여기관 목록 | KIMM, KAIST, 서울대, HD현대건설기계 등 |
| 연차 구조 | 단계/연도 | 1단계(2027-29), 2단계(30-31) |
| 세부기술 | 3축 이름 | 필드 특화 AI, 레트로핏 모듈, 시뮬레이션/실증 |

이 문서는 Phase 1 완료 후 자동 생성되며, 모든 서브에이전트가 동일한 컨텍스트를 참조하여 일관된 스타일의 프롬프트를 생성한다.

### 서브에이전트 전달 템플릿

```
당신은 figure-generator의 서브에이전트입니다.

## 공통 컨텍스트 (반드시 준수)
[consistency_context.md 내용 삽입]

## 담당 캡션
- 캡션명: [캡션명]
- 유형: [캡션 유형]
- 출처 문서: [출처 경로]

## 품질 요구사항
- 총 줄 수: 500줄 이상 (필수)
- 14개 섹션 모두 포함 (필수)
- ASCII 레이아웃 6개 영역 상세 기술
- 반드시 포함할 텍스트 50개 이상
- 참고 데이터 출처 테이블 8개 이상
- 플레이스홀더 사용 금지

## 출력
프롬프트를 완성하면 파일로 저장하고 경로를 반환하세요.
```

---

## Workflow

```
[Phase 0: 입력 검증]
    |
    +-- Step 0-1. 출력 디렉토리 확인
    |   +-- 사용자 제공 경로 존재 여부 확인
    |   +-- chapter_1/ ~ chapter_5/ 폴더 탐색
    |   +-- 마크다운 문서(.md) 목록 수집
    |
    +-- Step 0-2. 출력 폴더 설정
    |   +-- figures/ 폴더 존재 확인 (없으면 생성 예정 목록에 추가)
    |   +-- prompts/ 폴더 존재 확인 (없으면 생성 예정 목록에 추가)
    |   +-- 기존 이미지/프롬프트 목록 확인 (중복 방지)
    |
    +-- Step 0-3. Python 환경 확인
        +-- Python 3.8+ 설치 여부 확인
        +-- 필수 패키지 설치 확인: google-genai, Pillow
        +-- 미설치 시 안내: pip install google-genai Pillow
        +-- 설치 불가 시 프롬프트만 생성 모드로 전환

[Phase 1: 캡션 추출]
    |
    +-- Step 1-1. 전체 문서 스캔
    |   +-- chapter_1/ ~ chapter_5/ 내 모든 .md 파일 읽기
    |   +-- 이미지생성_프롬프트.md 파일 존재 시 별도 처리
    |   +-- 문서별 내용 메모리에 저장
    |
    +-- Step 1-2. 캡션 패턴 추출
    |   +-- 정규식 패턴 적용: /<([^,>]+)(,\s*출처:\s*[^>]+)?>/g
    |   +-- 추출 형식:
    |       - <이미지명>
    |       - <이미지명, 출처: 기관명 (연도)>
    |   +-- 중복 캡션 제거 (동일 캡션은 1회만 처리)
    |   +-- 캡션별 출처 문서 및 라인 번호 기록
    |
    +-- Step 1-3. 캡션 분류
    |   +-- 9가지 유형으로 분류:
    |       1. 비전/목표: 목표, 비전, 개념도 관련
    |       2. 로드맵: 로드맵, 일정, 타임라인 관련
    |       3. 연차별: 연차별, 년차별, 단계별 관련
    |       4. 추진체계: 추진체계, 조직, 역할 관련
    |       5. 투자계획: 투자, 예산, 재원 관련
    |       6. 협력체계: 협력, 네트워크, 파트너 관련
    |       7. 사업화: 사업화, 상용화, 활용 관련
    |       8. 개념도: 개념, 구조, 아키텍처 관련
    |       9. 기술분류: 기술분류, 체계, 분류 관련
    |   +-- 유형별 기본 프롬프트 템플릿 매핑
    |
    +-- Step 1-4. 캡션 목록 생성
        +-- caption_list.md 파일 생성
        +-- 포함 내용:
            - 총 캡션 수
            - 문서별 캡션 분포
            - 유형별 캡션 분포
            - 캡션 상세 목록 (번호, 캡션명, 유형, 출처 문서)
        +-- 사용자에게 확인 요청 (진행 여부)
            - auto_mode=true인 경우: 확인 없이 자동 진행

[Phase 2: 상세 프롬프트 생성]
    |
    +-- Step 2-1. 심층 컨텍스트 수집 (강화)
    |   +-- 각 캡션이 포함된 문서 전체 읽기
    |   +-- 캡션이 속한 ## 섹션 전체 분석
    |   +-- 관련 표/데이터 전체 수집 (해당 문서 내 모든 관련 표)
    |   +-- 연관 문서 교차 참조 (Chapter 1~5 간 연결 내용)
    |   +-- 핵심 용어/수치/기관명/연차별 내용 추출
    |   +-- 데이터 출처 기록: 문서명:라인번호 형식
    |   +-- 추출 대상:
    |       - 기술 용어 (예: CRISPR-Cas13a, ERCC2)
    |       - 수치 데이터 (예: 90% 이상, fM 수준)
    |       - 기관명 (예: 성균관대학교, 삼성서울병원)
    |       - 연차별 계획 및 목표
    |       - 성과 지표
    |   +-- consistency_context.md 생성:
    |       - 위 추출 데이터를 기반으로 일관성 컨텍스트 문서 생성
    |       - prompts/ 폴더에 저장
    |
    +-- Step 2-1a. 서브에이전트 병렬 생성 (parallel_mode=true 시 활성화)
    |   +-- 활성화 조건:
    |       - parallel_mode=true 이거나
    |       - 캡션 수 > 5개일 경우 자동 활성화
    |   +-- 병렬 그룹 구성 (유형별 최대 3개 동시 실행):
    |       - 그룹 1: 비전/목표, 개념도 유형
    |       - 그룹 2: 로드맵, 연차별 유형
    |       - 그룹 3: 추진체계, 협력체계 유형
    |       - 그룹 4: 투자계획, 사업화 유형
    |       - 그룹 5: 기술분류, 시장현황, 기타 유형
    |   +-- 각 서브에이전트 호출:
    |       - Task 도구 사용, subagent_type='general-purpose'
    |       - 서브에이전트 전달 템플릿 적용 (위 섹션 참조)
    |       - 전달 내용:
    |           1. consistency_context.md 전체 내용
    |           2. 해당 캡션의 문서 컨텍스트 (출처 문서 내용)
    |           3. 품질 요구사항 (500줄+, 14섹션, 50개 텍스트 등)
    |           4. 출력 경로 지정
    |       - 병렬 실행: 한 메시지에 여러 Task 호출 포함
    |   +-- 서브에이전트 결과 수집:
    |       - 각 에이전트 완료 대기
    |       - 생성된 프롬프트 파일 경로 수집
    |       - 품질 검증을 위해 Step 2-5로 전달
    |   +-- parallel_mode=false 시:
    |       - 이 단계 건너뛰고 Step 2-2로 직접 진행
    |       - 메인 에이전트가 순차적으로 모든 프롬프트 생성
    |
    +-- Step 2-2. 상세 프롬프트 초안 작성 (핵심 단계 - 품질 필수)
    |   +-- [필수] 모든 캡션에 대해 프롬프트 생성:
    |       - caption_list.md에 나열된 모든 캡션 대상 (예외 없음)
    |       - "핵심 이미지만" 또는 "주요 캡션만" 범위 축소 절대 금지
    |       - 우선순위와 무관하게 전체 캡션 처리
    |       - "생성 대기" 상태 캡션이 남아있으면 안 됨
    |   +-- 반드시 참고할 예시 (필수):
    |       - references/example_prompts.md 섹션 9 "완전한 상세 예시" (1040줄)
    |       - 이 예시와 동일한 수준의 상세함으로 작성해야 함
    |       - 예시보다 품질이 낮으면 Step 2-5에서 실패 처리됨
    |   +-- assets/output_template/prompt_template.md 구조 엄수
    |   +-- references/prompt_guide.md 규칙 적용
    |   +-- 14개 필수 섹션 포함 (모두 필수 - 생략 금지):
    |       1. 캡션 및 요약 (캡션 원문 + 핵심 요소 나열)
    |       2. 이미지 유형 (PPT 스타일, 해상도, 표현 방식)
    |       3. 색상 팔레트 (4색 HEX 코드 + 사용처)
    |       4. 전체 레이아웃 (ASCII 전체 구조 - 모든 영역 표시)
    |       5. 상단 영역 (ASCII 타이틀 바 상세)
    |       6. 좌측 영역 (ASCII + 모든 내용 구체적 기재)
    |       7. 우측 상단 영역 (ASCII + 모든 내용 구체적 기재)
    |       8. 우측 하단 영역 (ASCII + 모든 내용 구체적 기재)
    |       9. 하단 영역 (ASCII + 모든 내용 구체적 기재)
    |       10. 텍스트 규격 (폰트 크기/굵기/색상 모두 명시)
    |       11. 그래픽 요소 (박스/화살표/구분선 스타일 상세)
    |       12. 반드시 포함할 텍스트 (50개 이상, 카테고리별 분류)
    |       13. 참고 데이터 출처 테이블 (8개 이상, 출처 명시)
    |       14. 체크리스트 및 버전 관리:
    |           - 기술 용어 정확성 체크리스트 (10개 이상)
    |           - 디자인 일관성 체크포인트 (7개 이상)
    |           - 그림 구성 핵심 포인트 (5개)
    |           - 정보 계층 구조 (Primary/Secondary/Tertiary)
    |           - 버전 관리 (생성일/버전/출처 문서)
    |   +-- 프롬프트 품질 기준 (필수 - 미달 시 재작성):
    |       - 총 줄 수: 500줄 이상 (필수)
    |       - ASCII 레이아웃 영역: 6개 이상 (전체/상단/좌측/우측상단/우측하단/하단)
    |       - 반드시 포함할 텍스트: 50개 이상 (카테고리별 분류 필수)
    |       - 참고 데이터 출처 테이블: 8개 이상
    |       - 기술 용어 체크리스트: 10개 이상
    |       - 디자인 체크포인트: 7개 이상
    |       - 그림 구성 핵심 포인트: 5개
    |       - 정보 계층 구조: Primary/Secondary/Tertiary 모두 명시
    |   +-- 플레이스홀더 사용 절대 금지:
    |       - [내용], [항목명], [텍스트] 형식의 플레이스홀더 절대 금지
    |       - 모든 내용은 실제 문서에서 추출한 구체적 데이터로 채움
    |       - 추출 불가능한 경우에만 "해당 없음" 또는 "추가 정보 필요" 표기
    |       - ASCII 다이어그램 내 모든 박스에 실제 내용 기재 필수
    |   +-- 렌더링 금지 패턴 (중요 - references/prompt_guide.md 섹션 12 참조):
    |       - 표시 텍스트 옆 폰트 크기 직접 기재 금지: "제목" (24pt) ← 금지
    |       - 화살표 주석 사용 금지: ← 네이비 배경, → 청록색 테두리 ← 금지
    |       - 대괄호 지침 텍스트 사용 금지: [반 이상이 70세 이상임을 강조] ← 금지
    |       - 괄호 스타일 주석 사용 금지: (강조), (크게), (대형 숫자) ← 금지
    |       - 올바른 방식: 스타일 정보는 "텍스트 규격" 또는 "작성 지침" 섹션에 별도 기재
    |       - ASCII 레이아웃에는 실제 표시될 텍스트만 포함
    |
    +-- Step 2-3. 프롬프트 파일 저장 (강화)
    |   +-- 저장 전 확인:
    |       1. prompts/ 폴더 존재 확인 (없으면 생성)
    |       2. 기존 파일 백업 (덮어쓰기 방지)
    |   +-- 저장 실행:
    |       1. 프롬프트 내용을 파일로 저장
    |       2. 파일명: [순번]_[캡션명_snake_case].md
    |       3. 인코딩: UTF-8
    |   +-- 저장 후 확인:
    |       1. 파일 존재 여부 확인
    |       2. 파일 크기 확인 (최소 15KB 이상)
    |       3. 줄 수 확인 (최소 500줄 - Step 2-2 기준 준수)
    |       4. 저장 실패 시 에러 메시지 출력
    |   +-- 인덱스 업데이트:
    |       1. prompt_index.md 파일 생성/업데이트
    |       2. 모든 프롬프트 파일 목록 및 상태 기록
    |   +-- 저장 완료 보고:
    |       "[프롬프트 저장] [순번]_[캡션명].md"
    |       "  - 경로: [절대 경로]"
    |       "  - 크기: [KB]"
    |       "  - 줄 수: [N]줄"
    |
    +-- Step 2-4. 사용자 승인 프로세스
    |   +-- auto_mode=true인 경우:
    |       - 프롬프트 요약만 출력하고 자동으로 Phase 3로 진행
    |       - 사용자 확인 요청 건너뛰기
    |   +-- auto_mode=false인 경우 (기본값):
    |       +-- 프롬프트 요약 생성:
    |           각 캡션별로 다음 정보 제시:
    |           ┌──────────────────────────────────────────┐
    |           │ 캡션 [N]: [캡션명]                        │
    |           ├──────────────────────────────────────────┤
    |           │ 이미지 유형: [유형]                       │
    |           │ 레이아웃: [간략 설명]                     │
    |           │ 포함 텍스트: [N]개                        │
    |           │ 참고 데이터 테이블: [N]개                 │
    |           │ 프롬프트 파일: [파일 경로]                │
    |           │ 프롬프트 줄 수: [N]줄                     │
    |           └──────────────────────────────────────────┘
    |       +-- 사용자 확인 요청:
    |           "프롬프트 생성이 완료되었습니다."
    |           "prompts/ 폴더의 프롬프트 파일을 확인해주세요."
    |           ""
    |           "다음 중 선택해주세요:"
    |           "1. 모든 프롬프트 승인 → 이미지 생성 진행"
    |           "2. 특정 프롬프트 수정 요청 (번호 지정)"
    |           "3. 프롬프트만 저장하고 이미지 생성은 나중에"
    |       +-- 옵션별 처리:
    |           - 옵션 1: Phase 3로 진행
    |           - 옵션 2: 해당 프롬프트 수정 후 Step 2-3로 복귀
    |           - 옵션 3: Phase 5로 이동 (보고서만 생성)
    |
    +-- Step 2-5. 프롬프트 품질 검증 (필수 통과 단계)
        +-- [신규] 완전성 검증 (모든 캡션 처리 여부):
            - caption_list.md 총 캡션 수 = 생성된 프롬프트 수
            - 누락 캡션 있을 시 즉시 Step 2-1a로 회귀 (해당 캡션만 재처리)
            - "생성 대기" 상태 캡션 0개여야 통과
            - 검증 실패 시 오류 메시지:
              "완전성 검증 실패: [N]개 캡션 미처리 - [캡션명 목록]"
        +-- 14개 필수 섹션 완전성 검증 (모두 존재해야 통과):
            - [ ] 1. 캡션 및 요약 (캡션 원문 + 핵심 요소)
            - [ ] 2. 이미지 유형 (PPT 스타일, 해상도)
            - [ ] 3. 색상 팔레트 (4색 HEX 코드)
            - [ ] 4. 전체 레이아웃 (ASCII 전체 구조)
            - [ ] 5. 상단 영역 (ASCII 타이틀 바)
            - [ ] 6. 좌측 영역 (ASCII + 구체적 내용)
            - [ ] 7. 우측 상단 영역 (ASCII + 구체적 내용)
            - [ ] 8. 우측 하단 영역 (ASCII + 구체적 내용)
            - [ ] 9. 하단 영역 (ASCII + 구체적 내용)
            - [ ] 10. 텍스트 규격 (폰트 크기/굵기/색상)
            - [ ] 11. 그래픽 요소 (박스/화살표/스타일)
            - [ ] 12. 반드시 포함할 텍스트 (카테고리별 분류)
            - [ ] 13. 참고 데이터 출처 테이블
            - [ ] 14. 체크리스트 및 버전 관리
        +-- 수량 검증 (모두 충족해야 통과):
            - 총 줄 수: 500줄 이상 (필수)
            - ASCII 레이아웃 영역: 6개 이상
            - 반드시 포함할 텍스트: 50개 이상
            - 참고 데이터 출처 테이블: 8개 이상
            - 기술 용어 체크리스트: 10개 이상
            - 디자인 체크포인트: 7개 이상
            - 그림 구성 핵심 포인트: 5개
            - 정보 계층 구조: 3단계 모두 명시
        +-- 플레이스홀더 금지 검증:
            - [내용], [항목], [텍스트] 형식 검출 시 즉시 실패
            - 모든 ASCII 박스 내 실제 내용 기재 확인
            - 원본 문서에서 추출한 구체적 데이터인지 확인
        +-- 렌더링 금지 패턴 검증:
            - "텍스트" (24pt) 형식 검출 시 실패 - 폰트 크기가 텍스트와 함께 렌더링됨
            - ← 또는 → 화살표 주석 검출 시 실패 - 주석이 이미지에 렌더링됨
            - [설명 텍스트] 대괄호 지침 검출 시 실패 - 지침이 이미지에 렌더링됨
            - (강조), (크게) 등 괄호 스타일 주석 검출 시 실패
            - 검출 시 오류 메시지:
              "렌더링 금지 패턴 검출: [패턴] - 스타일 정보를 별도 섹션으로 분리하세요"
        +-- 검증 실패 시:
            - 미충족 항목별 구체적 개선 지시 출력:
              "실패: [항목명] - 현재 [N]개, 필요 [M]개 이상"
            - Step 2-2로 회귀하여 보완 (자동)
            - 3회 실패 시 사용자에게 수동 검토 요청

[Phase 3: 이미지 생성]
    |
    +-- Step 3-1. Python 스크립트 실행 준비
    |   +-- 스크립트 경로 확인: presentations/figure-generator/scripts/generate_images.py
    |   +-- 프롬프트 폴더 경로 확인: [출력 디렉토리]/prompts/
    |   +-- 출력 폴더 경로 확인: [출력 디렉토리]/figures/
    |   +-- Gemini API 설정 확인:
    |       - 모델: gemini-3-pro-image-preview
    |       - 해상도: 4K
    |       - 비율: 16:9
    |       - 사고모드: 활성화
    |       - 고급 텍스트 렌더링: 활성화
    |
    +-- Step 3-2. 이미지 생성 스크립트 실행
    |   +-- 실행 명령어:
    |       python scripts/generate_images.py \
    |         --prompts-dir [출력 디렉토리]/prompts/ \
    |         --output-dir [출력 디렉토리]/figures/
    |   +-- 스크립트 동작:
    |       1. prompts/ 폴더의 .md 파일 읽기
    |       2. 각 프롬프트에서 핵심 내용만 추출 (토큰 절약)
    |       3. Gemini API 호출하여 이미지 생성
    |       4. 캡션명 기반 파일명으로 저장
    |   +-- 실행 결과 모니터링:
    |       - 각 이미지 생성 진행 상황 출력
    |       - 사고 과정(thinking) 출력 (있는 경우)
    |       - 성공/실패 상태 표시
    |
    +-- Step 3-3. 생성 결과 확인
    |   +-- figures/ 폴더 내 이미지 파일 목록 확인
    |   +-- 예상 파일명: [순번]_[캡션명_snake_case].png
    |   +-- 파일 존재 여부 확인
    |   +-- 스크립트 종료 코드 확인 (0: 성공, 1: 일부 실패)
    |
    +-- Step 3-4. 실패 항목 처리
    |   +-- 스크립트 출력에서 실패 목록 확인
    |   +-- 실패 항목 있을 경우:
    |       - 해당 프롬프트 파일 검토
    |       - 프롬프트 간소화 후 재시도 가능
    |       - 최종 실패 시 수동 생성 가이드 제공
    |
    +-- Step 3-5. 진행 상황 보고
        +-- 총 처리 이미지 수 출력
        +-- 성공/실패 통계 출력
        +-- 실패 항목 목록 제공 (있을 경우)

[Phase 4: 검증]
    |
    +-- Step 4-1. 완료 확인
    |   +-- 생성된 이미지 파일 목록 수집
    |   +-- 캡션 목록(caption_list.md)과 대조
    |   +-- 누락된 캡션 식별
    |
    +-- Step 4-2. 누락 이미지 재생성
    |   +-- 누락된 캡션에 대해 Phase 3 재실행
    |   +-- 최대 재시도 3회
    |   +-- 재시도 간격: 10초 대기
    |   +-- 최종 실패 시 실패 목록에 추가 및 사용자 안내
    |
    +-- Step 4-3. 이미지 품질 검토 안내
        +-- 생성된 이미지 파일 경로 목록 제공
        +-- 수동 검토 권장 항목 표시:
            - 한글 텍스트 렌더링 품질
            - 레이아웃 정확성
            - 색상 일관성

[Phase 5: 완료 보고]
    |
    +-- Step 5-1. 실행 보고서 생성
    |   +-- figure_generation_report.md 생성
    |   +-- 포함 내용:
    |       - 실행 요약 (총 처리 캡션 수, 성공/실패 통계)
    |       - 캡션-이미지 매핑 테이블
    |       - 프롬프트 파일 위치 목록
    |       - 이미지 파일 위치 목록
    |       - 실패 항목 및 사유
    |       - 수동 검토 권장 항목
    |
    +-- Step 5-2. 문서 업데이트 가이드 제공
    |   +-- 각 캡션 위치에 이미지 삽입 방법 안내
    |   +-- 마크다운 이미지 링크 예시:
    |       - ![이미지명](figures/01_이미지명.png)
    |   +-- 문서별 업데이트 체크리스트 제공
    |
    +-- Step 5-3. 사용자 안내
        +-- 생성 완료 알림
        +-- 보고서 위치 안내
        +-- 후속 작업 안내:
            - 이미지 품질 검토
            - 필요시 재생성 요청 방법
            - 문서 업데이트 절차
```

---

## 캡션 추출 패턴

### 표준 캡션 형식

```
<이미지명>                           # 기본 형식
<이미지명, 출처: 기관명 (연도)>       # 출처 포함 형식
```

### 정규식 패턴

```regex
/<([^,>]+)(,\s*출처:\s*[^>]+)?>/g
```

### 캡션 유형 분류표

| 유형 | 키워드 | 캡션 예시 | 이미지 스타일 |
|------|--------|----------|--------------|
| 비전/목표 | 목표, 비전, 개념 | `<연구개발 목표 및 비전>` | 계층 구조도, 피라미드 |
| 로드맵 | 로드맵, 일정, 타임라인 | `<기술개발 로드맵>` | 타임라인, 간트 차트 |
| 연차별 | 연차별, 년차별, 단계별 | `<연차별 연구목표 및 내용>` | 테이블, 타임라인 |
| 추진체계 | 추진체계, 조직, 역할 | `<사업 추진 체계>` | 조직도 |
| 투자계획 | 투자, 예산, 재원 | `<연도별 기술별 투자계획>` | 막대 그래프, 테이블 |
| 협력체계 | 협력, 네트워크, 파트너 | `<협력체계>` | 네트워크 다이어그램 |
| 사업화 | 사업화, 상용화, 활용 | `<기술 사업화 전략>` | 흐름도, 로드맵 |
| 개념도 | 개념, 구조, 아키텍처 | `<사업개념도>` | 블록 다이어그램 |
| 기술분류 | 기술분류, 체계, 분류 | `<기술분류 체계도>` | Technology Tree |

---

## 프롬프트 생성 규칙

### 기본 구조

모든 프롬프트는 다음 구조를 따른다:

```markdown
[이미지 생성 프롬프트]

## 이미지 유형
- PPT 슬라이드 스타일의 인포그래픽
- 정부 국가연구개발 과제 발표자료 수준의 전문적 도식
- 가로형(16:9 비율), 고해상도, 벡터 그래픽 스타일
- 한글로 작성됨

## 색상 팔레트 (4색 제한)
1. 주조색: #1E3A5F (진한 네이비) - 제목, 핵심 박스
2. 보조색: #4A90A4 (청록색) - 화살표, 프로세스
3. 강조색: #2E7D5A (진한 녹색) - 성과/목표 달성
4. 배경색: #F5F7FA (밝은 회색) - 배경

## 레이아웃 구성
[캡션 유형에 따른 상세 레이아웃]

## 반드시 포함할 텍스트
[문서에서 추출한 핵심 텍스트 목록]

## 그래픽 요소
- 모든 박스: 둥근 모서리(radius 8px)
- 그림자: 연한 드롭섀도우
- 화살표: 두께 3px
- 텍스트: 가독성 우선
```

### 텍스트 규격

| 요소 | 크기 | 굵기 |
|------|------|------|
| 대제목 | 24pt | Bold |
| 섹션 제목 | 18pt | Bold |
| 소제목 | 14pt | SemiBold |
| 본문 | 11-12pt | Regular |
| 강조텍스트 | 12pt | Bold |

### 4색 팔레트 (기본값)

| 역할 | 색상명 | HEX 코드 | 사용처 |
|------|--------|----------|--------|
| 주조색 | 진한 네이비 | #1E3A5F | 제목, 핵심 박스, 후반기 |
| 보조색 | 청록색 | #4A90A4 | 화살표, 프로세스, 전반기 |
| 강조색 | 진한 녹색 | #2E7D5A | 성과/목표 달성 |
| 배경색 | 밝은 회색 | #F5F7FA | 배경 |

---

## Gemini API 호출 방식

### generate_images.py 스크립트 사용

```bash
# 실행 명령어
python scripts/generate_images.py \
  --prompts-dir [출력 디렉토리]/prompts/ \
  --output-dir [출력 디렉토리]/figures/
```

### API 설정

| 항목 | 값 | 설명 |
|------|---|------|
| 모델 | gemini-3-pro-image-preview | 고급 텍스트 렌더링 지원 |
| 해상도 | 4K | 최고 해상도 (3840x2160) |
| 비율 | 16:9 | PPT 슬라이드 표준 |
| 사고모드 | 활성화 | 복잡한 레이아웃 처리 |

### 프롬프트 파싱 (토큰 절약)

스크립트는 프롬프트 파일에서 핵심 섹션(1~12)만 추출하여 API에 전달:
- 섹션 1~12: 캡션, 유형, 색상, 레이아웃, 텍스트 등 (포함)
- 섹션 13~14: 출처 테이블, 체크리스트 (제외 - 이미지 생성에 불필요)

### 에러 처리

```
1. API 호출 실패 시:
   - 5초 대기 후 재시도 (최대 3회)
   - 최종 실패 시 실패 목록에 추가

2. Rate Limit 방지:
   - 각 이미지 생성 후 2초 대기

3. Python 환경 없을 시:
   - 프롬프트만 생성 모드로 전환
   - 수동 생성 가이드 제공
```

---

## Output Structure

### 출력 디렉토리 구조

```
output/[프로젝트명]/
├── figures/
│   ├── 01_연구개발_목표_및_비전.png
│   ├── 02_기술개발_로드맵.png
│   ├── 03_연차별_연구목표_및_내용.png
│   ├── 04_사업_추진_체계.png
│   ├── 05_연도별_기술별_투자계획.png
│   ├── 06_협력체계.png
│   ├── 07_기술_사업화_전략.png
│   └── ...
├── prompts/
│   ├── 01_연구개발_목표_및_비전.md
│   ├── 02_기술개발_로드맵.md
│   ├── 03_연차별_연구목표_및_내용.md
│   └── ...
│   └── prompt_index.md
├── caption_list.md
└── figure_generation_report.md
```

### 파일명 규칙

- 순번: 2자리 (01, 02, ...)
- 캡션명: snake_case 변환
- 공백 → 언더스코어(_)
- 특수문자 제거
- 예: `<연구개발 목표 및 비전>` → `01_연구개발_목표_및_비전.png`

---

## Writing Guidelines

### 프롬프트 작성 원칙

1. 완결성: 프롬프트만으로 AI가 이미지를 생성하는데 부족한 내용이 없도록 작성
2. 구체성: 레이아웃, 색상, 텍스트 위치를 명확히 지정
3. 일관성: 전체 이미지 시리즈의 디자인 통일감 유지
4. 가독성: 텍스트 크기, 간격을 충분히 확보
5. 전문성: 정부 국가연구개발 과제 발표자료 수준 유지

### 이미지 디자인 원칙

- 과도한 색상 사용 금지 (4색 이하)
- 지나치게 화려하지 않은 디자인
- 시인성과 구성력 우선
- 정부 공식 발표자료에서 사용될 수 있는 수준

---

## Resources

### references/

- `prompt_guide.md`: 이미지 프롬프트 작성 상세 가이드
- `caption_patterns.md`: 캡션 추출 패턴 및 분류 가이드
- `example_prompts.md`: 캡션 유형별 예시 프롬프트

### assets/

- `output_template/figure_generation_report.md`: 실행 보고서 템플릿
- `output_template/prompt_template.md`: 개별 프롬프트 기본 템플릿

---

## Usage Example

### 입력 예시

```
figure-generator 스킬을 사용해서 연구계획서 이미지를 생성해줘.
출력 문서 경로: output/농업로봇_군집제어_2027/
```

### 수행 절차

1. **Phase 0**: `output/농업로봇_군집제어_2027/` 경로 확인, chapter_1~5 폴더 탐색
2. **Phase 1**: 전체 문서에서 `<캡션>` 패턴 추출, 15개 캡션 발견, 유형별 분류
3. **Phase 2**: 각 캡션별 상세 프롬프트 생성 (prompt_guide.md 규칙 적용)
4. **Phase 3**: nanobanana generate_image로 15개 이미지 순차 생성
5. **Phase 4**: 생성 결과 검증, 누락 항목 재생성
6. **Phase 5**: figure_generation_report.md 생성 및 완료 보고

### 출력 파일

1. `figures/`: 생성된 이미지 파일들 (PNG)
2. `prompts/`: 각 이미지의 프롬프트 파일들 (MD)
3. `caption_list.md`: 추출된 캡션 목록
4. `figure_generation_report.md`: 실행 보고서

---

## 프롬프트만 생성 모드

Python 환경이 없거나 Gemini API를 사용할 수 없는 경우, 프롬프트만 생성하고 수동 생성 가이드를 제공한다.

### 대체 이미지 생성 도구

| 도구 | 특징 | 권장 사용 |
|------|------|----------|
| Gemini (수동) | Google AI Studio에서 직접 사용 | 프롬프트 복사-붙여넣기 |
| DALL-E 3 | OpenAI, 높은 텍스트 렌더링 품질 | 한글 텍스트 포함 이미지 |
| Midjourney v6 | 높은 디자인 품질 | 시각적 완성도 중시 |

### 수동 생성 가이드

1. `prompts/` 폴더의 프롬프트 파일 열기
2. 섹션 1~12 내용만 복사 (섹션 13~14는 제외)
3. Google AI Studio 또는 선택한 AI 이미지 생성 도구에 붙여넣기
4. 설정: 16:9 비율, 최고 해상도
5. 생성된 이미지를 `figures/` 폴더에 저장
6. 파일명 규칙에 맞게 이름 변경
